<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>SYNDICATE</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      background:#0f0f0f;
      color:#fff;
      font-family:Arial;
      padding:16px;
    }
    .btn {
      padding:12px;
      background:#1e1e1e;
      margin:8px 0;
      border-radius:8px;
      cursor:pointer;
      text-align:center;
      opacity:0.5;
    }
    .btn.active {
      opacity:1;
    }
    .task {
      margin-top:16px;
    }
    .check {
      margin:6px 0;
      cursor:pointer;
    }
    pre {
      background:#111;
      padding:10px;
      overflow:auto;
      font-size:12px;
    }
  </style>
</head>
<body>

<h1>SYNDICATE</h1>

<div id="tasksBtn" class="btn">üìã –ú–æ–∏ –∑–∞–¥–∞–Ω–∏—è</div>

<div id="output"></div>

<script>
const tg = Telegram.WebApp;
tg.ready();

let TOKEN = null;
const btn = document.getElementById("tasksBtn");
const output = document.getElementById("output");

function api(url, options = {}) {
  return fetch(url, {
    ...options,
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + TOKEN
    }
  }).then(r => r.json());
}

/* ===== AUTH ===== */
fetch("/auth", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ initData: tg.initData })
})
.then(r => r.json())
.then(d => {
  if (!d.token) {
    output.innerHTML = "<p>‚ùå –¢–æ–∫–µ–Ω –Ω–µ –ø–æ–ª—É—á–µ–Ω</p>";
    return;
  }
  TOKEN = d.token;
  btn.classList.add("active");
  btn.onclick = openTasks;
})
.catch(err => {
  output.innerHTML = "<p>‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</p>";
});

/* ===== LOAD TASK ===== */
function openTasks() {
  output.innerHTML = "<p>‚è≥ –ó–∞–≥—Ä—É–∂–∞—é –∑–∞–¥–∞–Ω–∏–µ...</p>";

  api("/my-tasks").then(d => {
    console.log("MY TASKS RESPONSE:", d);

    // üîé –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º RAW –æ—Ç–≤–µ—Ç
    let html = `
      <h3>RAW RESPONSE</h3>
      <pre>${JSON.stringify(d, null, 2)}</pre>
    `;

    if (!d.task) {
      output.innerHTML = html + "<p>‚ùå –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è</p>";
      return;
    }

    html += `
      <div class="task">
        <h2>–î–ï–ù–¨ ${d.task.day} ‚Äî ${d.task.title}</h2>
        <h3>–ú–∏—Å—Å–∏—è: "${d.task.mission}"</h3>
        <p>${d.task.description || ""}</p>
        <h4>–ß–µ–∫‚Äë–ª–∏—Å—Ç</h4>
    `;

    if (!d.checklist || d.checklist.length === 0) {
      html += "<p>‚ö†Ô∏è –ü—É–Ω–∫—Ç–æ–≤ —á–µ–∫‚Äë–ª–∏—Å—Ç–∞ –Ω–µ—Ç</p>";
    } else {
      d.checklist.forEach(i => {
        html += `
          <div class="check" onclick="toggle('${i.id}', ${!i.done})">
            ${i.done ? "‚úÖ" : "‚¨ú"} ${i.title}
          </div>
        `;
      });
    }

    html += "</div>";
    output.innerHTML = html;
  });
}

/* ===== TOGGLE ===== */
function toggle(id, done) {
  api("/checklist/toggle", {
    method: "POST",
    body: JSON.stringify({ checklist_id: id, done })
  }).then(openTasks);
}
</script>

</body>
</html>
