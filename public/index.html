<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>SYNDICATE</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      background:#0f0f0f;
      color:#fff;
      font-family:Arial;
      padding:16px;
    }
    .btn {
      padding:12px;
      background:#1e1e1e;
      margin:6px 0;
      border-radius:8px;
      cursor:pointer;
      text-align:center;
    }
    .check { cursor:pointer; margin:6px 0; }
    .admin { margin-top:20px; border-top:1px solid #333; padding-top:10px; }
    input { width:100%; padding:8px; margin:6px 0; }
  </style>
</head>
<body>

<h1>SYNDICATE</h1>

<div class="btn" onclick="openTasks()">üìã –ú–æ–∏ –∑–∞–¥–∞–Ω–∏—è</div>

<div id="adminPanel" class="admin" style="display:none">
  <div class="btn" onclick="openDay(1)">–û—Ç–∫—Ä—ã—Ç—å –¥–µ–Ω—å 1</div>

  <hr>

  <div class="btn" onclick="loadChecklist(1)">‚öô –ß–µ–∫‚Äë–ª–∏—Å—Ç –¥–Ω—è 1</div>
  <input id="newItem" placeholder="–ù–æ–≤—ã–π –ø—É–Ω–∫—Ç">
  <div class="btn" onclick="addItem(1)">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—É–Ω–∫—Ç</div>
  <div id="adminChecklist"></div>
</div>

<div id="output"></div>

<script>
const tg = Telegram.WebApp;
tg.ready();

let TOKEN = null;

function api(url, options={}) {
  return fetch(url, {
    ...options,
    headers: {
      "Content-Type":"application/json",
      Authorization:"Bearer " + TOKEN
    }
  }).then(r=>r.json());
}

/* AUTH */
fetch("/auth", {
  method:"POST",
  headers:{ "Content-Type":"application/json" },
  body:JSON.stringify({ initData: tg.initData })
})
.then(r=>r.json())
.then(d=>{
  TOKEN = d.token;
  return api("/me");
})
.then(me=>{
  if (me.user.is_admin) {
    adminPanel.style.display = "block";
  }
});

/* USER TASKS */
function openTasks() {
  api("/my-tasks").then(d=>{
    if (!d.task) {
      output.innerText = "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π";
      return;
    }

    let html = `<h3>${d.task.title}</h3><p>${d.task.mission}</p>`;
    d.checklist.forEach(i=>{
      html += `
        <div class="check" onclick="toggle('${i.id}', ${!i.done})">
          ${i.done ? "‚úÖ" : "‚¨ú"} ${i.title}
        </div>`;
    });
    output.innerHTML = html;
  });
}

function toggle(id, done) {
  api("/checklist/toggle", {
    method:"POST",
    body:JSON.stringify({ checklist_id:id, done })
  }).then(openTasks);
}

/* ADMIN */
function openDay(day) {
  api("/admin/open-day", {
    method:"POST",
    body:JSON.stringify({ day })
  }).then(()=>alert("–î–µ–Ω—å –æ—Ç–∫—Ä—ã—Ç"));
}

function loadChecklist(day) {
  api(`/admin/checklist/${day}`).then(d=>{
    let html="";
    d.items.forEach(i=>{
      html+=`
        <div>
          ‚Ä¢ ${i.title}
          <span style="color:red;cursor:pointer"
            onclick="deleteItem('${i.id}',${day})"> ‚úñ</span>
        </div>`;
    });
    adminChecklist.innerHTML = html;
  });
}

function addItem(day) {
  const title = newItem.value.trim();
  if (!title) return;

  api("/admin/checklist", {
    method:"POST",
    body:JSON.stringify({ day, title })
  }).then(()=>{
    newItem.value="";
    loadChecklist(day);
  });
}

function deleteItem(id, day) {
  api(`/admin/checklist/${id}`, { method:"DELETE" })
    .then(()=>loadChecklist(day));
}
</script>
</body>
</html>
