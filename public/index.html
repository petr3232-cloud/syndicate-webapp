<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>SYNDICATE</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      background: #0f0f0f;
      color: #fff;
      font-family: Arial, sans-serif;
      padding: 16px;
    }
    h1 { text-align: center; }
    .btn {
      padding: 14px;
      background: #1e1e1e;
      border-radius: 8px;
      margin: 6px 0;
      cursor: pointer;
      text-align: center;
    }
    .admin { margin-top: 20px; border-top: 1px solid #333; padding-top: 10px; }
    .check { cursor: pointer; margin: 6px 0; }
    #output { white-space: pre-wrap; margin-top: 12px; }
  </style>
</head>
<body>

<h1>SYNDICATE</h1>

<div class="btn" onclick="openTasks()">üìã –ú–æ–∏ –∑–∞–¥–∞–Ω–∏—è</div>

<div id="adminPanel" class="admin" style="display:none">
  <div class="btn" onclick="openDay(1)">–û—Ç–∫—Ä—ã—Ç—å –¥–µ–Ω—å 1</div>
  <div class="btn" onclick="openDay(2)">–û—Ç–∫—Ä—ã—Ç—å –¥–µ–Ω—å 2</div>
</div>

<div id="output"></div>

<script>
const tg = window.Telegram.WebApp;
tg.ready();

let TOKEN = null;
let ME = null;

function api(url, options={}) {
  return fetch(url, {
    ...options,
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + TOKEN
    }
  }).then(r => r.json());
}

/* AUTH */
fetch("/auth", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ initData: tg.initData })
})
.then(r => r.json())
.then(d => {
  TOKEN = d.token;
  return api("/me");
})
.then(me => {
  ME = me.user;
  if (ME.is_admin) {
    document.getElementById("adminPanel").style.display = "block";
  }
});

/* TASKS */
function openTasks() {
  api("/my-tasks").then(data => {
    if (!data.task) {
      output.innerText = "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π";
      return;
    }

    let html = `üî• ${data.task.title}\n\n${data.task.mission}\n\n`;

    data.checklist.forEach(i => {
      html += `<div class="check" onclick="toggle('${i.id}', ${!i.done})">
        ${i.done ? "‚úÖ" : "‚¨ú"} ${i.title}
      </div>`;
    });

    output.innerHTML = html;
  });
}

function toggle(id, done) {
  api("/checklist/toggle", {
    method: "POST",
    body: JSON.stringify({ checklist_id: id, done })
  }).then(openTasks);
}

function openDay(day) {
  api("/admin/open-day", {
    method: "POST",
    body: JSON.stringify({ day })
  }).then(() => alert("–î–µ–Ω—å –æ—Ç–∫—Ä—ã—Ç"));
}
</script>
</body>
</html>
