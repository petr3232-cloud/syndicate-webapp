<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>SYNDICATE</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
body { background:#0f0f0f; color:#fff; font-family:Arial; padding:16px }
.btn { background:#1e1e1e; padding:12px; margin:6px 0; border-radius:8px; cursor:pointer }
.day { display:inline-block; margin:4px; padding:8px 12px; background:#222; border-radius:6px; cursor:pointer }
.check { margin:6px 0; cursor:pointer }
.check.done { opacity:.6; text-decoration:line-through }
</style>
</head>
<body>

<h1>SYNDICATE</h1>
<div id="days"></div>
<div id="content"></div>

<script>
const tg = Telegram.WebApp;
tg.ready();

let TOKEN = null;
let STATE = null;

function api(url, options={}) {
  return fetch(url, {
    ...options,
    headers: {
      "Content-Type":"application/json",
      Authorization:"Bearer "+TOKEN
    }
  }).then(r=>r.json());
}

/* AUTH */
fetch("/auth", {
  method:"POST",
  headers:{ "Content-Type":"application/json" },
  body: JSON.stringify({ initData: tg.initData })
})
.then(r=>r.json())
.then(d => {
  TOKEN = d.token;
  loadDays();
});

/* DAYS */
function loadDays() {
  api("/days").then(d => {
    days.innerHTML = d.days.map(day =>
      `<span class="day" onclick="openDay(${day})">День ${day}</span>`
    ).join("");
  });
}

/* TASK */
function openDay(day) {
  api("/task/"+day).then(d => {
    STATE = d;
    render();
  });
}

function render() {
  const { task, checklist } = STATE;
  let html = `<h2>День ${task.day} — ${task.title}</h2>
  <p>${task.description.replace(/\n/g,"<br>")}</p><h3>Чек‑лист</h3>`;
  checklist.forEach(i => {
    html += `<div class="check ${i.done?"done":""}"
      onclick="toggle('${i.id}')">${i.done?"✅":"⬜"} ${i.title}</div>`;
  });
  content.innerHTML = html;
}

function toggle(id) {
  const item = STATE.checklist.find(i=>i.id===id);
  item.done = !item.done;
  render();
  api("/checklist/toggle", {
    method:"POST",
    body: JSON.stringify({ checklist_id:id, done:item.done })
  });
}
</script>
</body>
</html>
