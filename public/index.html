<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>SYNDICATE</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      background:#0f0f0f;
      color:#fff;
      font-family:Arial, sans-serif;
      padding:16px;
    }
    h1, h2, h3, h4 { margin: 8px 0; }
    .btn {
      padding:14px;
      background:#1e1e1e;
      margin:10px 0;
      border-radius:10px;
      cursor:pointer;
      text-align:center;
      font-size:16px;
    }
    .task {
      margin-top:16px;
    }
    .check {
      margin:8px 0;
      cursor:pointer;
      user-select:none;
      padding:8px;
      border-radius:6px;
    }
    .check.done {
      opacity:0.6;
      text-decoration:line-through;
    }
  </style>
</head>
<body>

<h1>SYNDICATE</h1>

<div class="btn" onclick="openTasks()">üìã –ú–æ–∏ –∑–∞–¥–∞–Ω–∏—è</div>
<div id="output"></div>

<script>
const tg = Telegram.WebApp;
tg.ready();

let TOKEN = null;
let STATE = null;

/* ===== API ===== */
function api(url, options = {}) {
  return fetch(url, {
    ...options,
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + TOKEN
    }
  }).then(r => r.json());
}

/* ===== AUTH ===== */
fetch("/auth", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ initData: tg.initData })
})
.then(r => r.json())
.then(d => {
  TOKEN = d.token;
});

/* ===== LOAD TASK ===== */
function openTasks() {
  api("/my-tasks").then(d => {
    if (!d.ok || !d.task) {
      output.innerHTML = "<p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π</p>";
      return;
    }
    STATE = d;
    render();
  });
}

/* ===== RENDER ===== */
function render() {
  const { task, checklist } = STATE;

  let html = `
    <div class="task">
      <h2>–î–ï–ù–¨ ${task.day} ‚Äî ${task.title}</h2>
      <h3>–ú–∏—Å—Å–∏—è: ¬´${task.mission}¬ª</h3>
      <p>${task.description.replace(/\n/g, "<br>")}</p>
      <h4>–ß–µ–∫‚Äë–ª–∏—Å—Ç</h4>
  `;

  if (!checklist.length) {
    html += "<p>–ü—É–Ω–∫—Ç–æ–≤ —á–µ–∫‚Äë–ª–∏—Å—Ç–∞ –Ω–µ—Ç</p>";
  } else {
    checklist.forEach(i => {
      html += `
        <div class="check ${i.done ? "done" : ""}"
             onclick="toggle('${i.id}')">
          ${i.done ? "‚úÖ" : "‚¨ú"} ${i.title}
        </div>
      `;
    });
  }

  html += "</div>";
  output.innerHTML = html;
}

/* ===== TOGGLE (–û–ü–¢–ò–ú–ò–°–¢–ò–ß–ù–û) ===== */
function toggle(id) {
  const item = STATE.checklist.find(i => i.id === id);
  if (!item) return;

  // UI —Å—Ä–∞–∑—É
  item.done = !item.done;
  render();

  // —Å–µ—Ä–≤–µ—Ä –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
  api("/checklist/toggle", {
    method: "POST",
    body: JSON.stringify({
      checklist_id: id,
      done: item.done
    })
  });
}
</script>

</body>
</html>
